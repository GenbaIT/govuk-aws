# This is a snippet so should not have a shebang
# shellcheck disable=SC2148
#
# Snippet: attach-volumes
#

logger "[$(date '+%H:%M:%S %d-%m-%Y')] START SNIPPET: attach-volumes"

# The environment variables INSTANCE_ID and REGION are set
# in the base snippet

F_MIGRATION=$(facter aws_migration)
F_STACKNAME=$(facter aws_stackname)
F_HOSTNAME=$(facter aws_hostname)

# Create blank volume
DEVICE=$(aws ec2 create-volume \
    --size 20 \
    --region $REGION \
    --availability-zone $AWS_DEFAULT_REGION \
    --tag-specifications "ResourceType=volume,Tags=[{Key=Device,Value=xvdf},{Key=Name,Value=blue-mapit},{Key=Project,Value=$F_STACKNAME},{Key=aws_migration,Value=$F_MIGRATION},{Key=aws_hostname,Value=$F_HOSTNAME},{Key=aws_stackname,Value=$F_STACKNAME}]" | jq -r '.VolumeId ')

# Wait for volume to be created before attaching
x=0
while [[ $x -lt 10 ]]; do
  if ! [[ -z $DEVICE ]] ; then
    sleep 1
  else
    break
  fi
  x=$((x+1))
done

logger "[$(date '+%H:%M:%S %d-%m-%Y')] attach-volume: attaching volume to /dev/$DEVICE ..."
aws ec2 attach-volume --volume-id ${DEVICE} --instance-id $INSTANCE_ID --device /dev/$DEVICE --region $REGION

x=0
while [[ $x -lt 10 ]]; do
  if ! [[ -e /dev/$DEVICE ]] ; then
    sleep 1
  else
    break
  fi
  x=$((x+1))
done


logger "[$(date '+%H:%M:%S %d-%m-%Y')] attach-volume: /dev/$DEVICE does not contain any partition, Puppet will format the disk"


logger "[$(date '+%H:%M:%S %d-%m-%Y')] END SNIPPET: attach-volumes"
